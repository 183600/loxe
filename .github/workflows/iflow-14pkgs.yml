name: iflow-14pkgs-autoloop

on:
  workflow_dispatch:
  push:
    branches: [ main ]

concurrency:
  group: iflow-14pkgs-autoloop-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

jobs:
  autoloop:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      WORK_BRANCH: main
      RUN_HOURS: 4
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      IFLOW_BASE_URL: https://maas-api.cn-huabei-1.xf-yun.com/v2
      IFLOW_MODEL_NAME: xopglm47blth2
      GH_TOKEN: ${{ secrets.IFLOW_PAT }}
      MAX_LOOPS: 10

    steps:
      - name: Checkout (PAT)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.IFLOW_PAT }}
          fetch-depth: 0

      - name: Git identity
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "iflow-bot"
          git config user.email "iflow-bot@users.noreply.github.com"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install iFlow CLI
        shell: bash
        run: |
          set -euo pipefail
          npm i -g @iflow-ai/iflow-cli@latest
          iflow --version

      - name: Install GNU Parallel
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y parallel

      - name: Verify secrets
        shell: bash
        run: |
          set -euo pipefail
          test -n "${IFLOW_API_KEY:-}" || (echo "Missing IFLOW_API_KEY" && exit 1)

      - name: Make scripts executable
        shell: bash
        run: |
          chmod +x scripts/iflow_14pkgs_loop.sh
          chmod +x scripts/iflow_pkg_loop.sh

      - name: Run loop (timeboxed)
        shell: bash
        run: |
          set -euo pipefail
          timeout --signal=TERM $(( RUN_HOURS * 3600 )) bash scripts/iflow_14pkgs_loop.sh || true

      - name: Final commit & push
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${WORK_BRANCH:-main}"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "ci: 14pkgs autoloop batch (run $GITHUB_RUN_ID)" || true
          fi
          git fetch origin "${BRANCH}" --prune
          git push origin "HEAD:${BRANCH}" --follow-tags --force-with-lease

      - name: Trigger next loop
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "Triggering next workflow run..."
          gh workflow run iflow-14pkgs.yml \
            --repo "${{ github.repository }}" \
            --ref main
          echo "Next run triggered successfully."
