jobs:
  run-js-5h:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      RUN_HOURS: 5
      WORK_BRANCH: main
      RELEASE_MARKER_FILE: .git/iflow_release_tag
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      IFLOW_BASE_URL: https://maas-api.cn-huabei-1.xf-yun.com/v2
      IFLOW_MODEL_NAME: xopglm47blth2
      GH_TOKEN: ${{ secrets.IFLOW_PAT }}

    steps:
      - name: Checkout with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.IFLOW_PAT }}
          fetch-depth: 0

      - name: Ensure branch and git identity
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${WORK_BRANCH:-main}"
          git fetch origin "${BRANCH}" --prune
          git checkout -B "${BRANCH}" "origin/${BRANCH}"
          git config user.name "iflow-bot"
          git config user.email "iflow-bot@users.noreply.github.com"

      # --- 修改 1: 安装 GNU Parallel ---
      - name: Install System Dependencies
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y parallel
          # 避免并行计算引用声明干扰日志
          mkdir -p ~/.parallel
          touch ~/.parallel/will-cite

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install iFlow CLI
        shell: bash
        run: |
          set -euo pipefail
          bun install -g @iflow-ai/iflow-cli@latest
          iflow --version

      - name: Verify IFLOW_API_KEY
        shell: bash
        run: |
          set -euo pipefail
          test -n "${IFLOW_API_KEY:-}" || { echo "Missing IFLOW_API_KEY secret"; exit 1; }

      - name: Install Project Dependencies (Bun)
        shell: bash
        run: |
          set -euo pipefail
          bun install

      # --- 修改 2: 确保所有脚本具有执行权限 ---
      - name: Make scripts executable
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/iflow_14pkgs_loop.sh
          # 确保被调用的子脚本也可被 bash 执行（虽然 bash xxx.sh 不需要+x，但为了保险起见）
          chmod +x scripts/iflow_pkg_loop.sh || true

      # --- 修改 3: 显式设置 PROJECT_ROOT ---
      - name: Run for ${{ env.RUN_HOURS }} hours
        shell: bash
        env:
          # 关键修正：覆盖脚本中的默认 Termux 路径
          # github.workspace 通常是 /home/runner/work/RepoName/RepoName
          PROJECT_ROOT: ${{ github.workspace }}
        run: |
          set -euo pipefail
          echo "Starting loop at: $(pwd)"
          echo "PROJECT_ROOT is set to: $PROJECT_ROOT"
          # 使用 timeout 配合脚本内部的 trap 信号处理
          timeout --signal=TERM $(( RUN_HOURS * 3600 )) bash scripts/iflow_14pkgs_loop.sh || true

      - name: Commit & push to GitHub
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${WORK_BRANCH:-main}"

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "ci: ${RUN_HOURS}h batch update (run $GITHUB_RUN_ID)" || true
          fi

          MARKER_FILE="${RELEASE_MARKER_FILE}"
          if [[ ! -f "${MARKER_FILE}" ]]; then
            GIT_DIR_REAL="$(git rev-parse --git-dir 2>/dev/null || echo ".git")"
            MARKER_FILE="${GIT_DIR_REAL%/}/iflow_release_tag"
          fi
          if [[ -f "${MARKER_FILE}" ]]; then
            echo "Release tag prepared: $(cat "${MARKER_FILE}")"
          fi

          git push origin "HEAD:${BRANCH}" --follow-tags --force