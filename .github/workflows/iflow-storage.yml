name: iflow-storage

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "packages/storage/**"
      - "pnpm-lock.yaml"
      - "package.json"
      - "pnpm-workspace.yaml"

concurrency:
  group: iflow-storage-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      WORK_BRANCH: main
      PKG: storage
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      IFLOW_BASE_URL: https://apis.iflow.cn/v1
      IFLOW_MODEL_NAME: glm-4.6
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.IFLOW_PAT }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install iFlow CLI
        run: npm i -g @iflow-ai/iflow-cli@latest

      - name: Git identity
        run: |
          git config user.name "iflow-bot"
          git config user.email "iflow-bot@users.noreply.github.com"

      - name: Run package loop (storage)
        run: |
          chmod +x scripts/iflow_js_pkg_loop.sh
          timeout --signal=TERM 5h bash scripts/iflow_js_pkg_loop.sh || true

      - name: Push back
        if: always()
        run: |
          git push origin "HEAD:${WORK_BRANCH}" --force
